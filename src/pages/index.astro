---
import Layout from "../layouts/Layout.astro";
import Button from "../components/Button.astro";
import { readdirSync, statSync, existsSync, mkdirSync } from "node:fs";
import { join, extname, basename } from "node:path";
import { fileURLToPath } from "node:url";
import sharp from "sharp";

// Build-time discovery of images from `public/gallery`
let galleryImages: string[] = [];
try {
	const galleryDirUrl = new URL("../../public/gallery/", import.meta.url);
	const galleryDirPath = fileURLToPath(galleryDirUrl);
	const allowedExtensions = new Set([
		".jpg",
		".jpeg",
		".png",
		".webp",
		".gif",
		".avif",
		".heic",
		".heif",
	]);
	const entries = readdirSync(galleryDirPath);

	const visited = new Set<string>();
	const items: Array<{ url: string; mtime: number }> = [];

	for (const name of entries) {
		const fullPath = join(galleryDirPath, name);
		let stats: ReturnType<typeof statSync> | null = null;
		try {
			stats = statSync(fullPath);
		} catch {
			continue;
		}
		if (!stats.isFile()) continue;

		const ext = extname(name).toLowerCase();
		if (!allowedExtensions.has(ext)) continue;

		// Handle HEIC/HEIF by converting to WEBP at build time and using the WEBP in the gallery
		if (ext === ".heic" || ext === ".heif") {
			const destName = `${basename(name, ext)}.webp`;
			const destPath = join(galleryDirPath, destName);
			if (!existsSync(destPath)) {
				try {
					// Ensure directory exists (paranoia for nested paths)
					mkdirSync(galleryDirPath, { recursive: true });
					await sharp(fullPath)
						.toColorspace("srgb")
						.webp({ quality: 82 })
						.toFile(destPath);
				} catch {
					// If conversion fails, skip adding the HEIC file (since many browsers can't render it)
					continue;
				}
			}
			if (!visited.has(destName)) {
				const mtime = statSync(destPath).mtimeMs;
				items.push({ url: `/gallery/${destName}`, mtime });
				visited.add(destName);
			}
			continue;
		}

		// Convert JPEG/JPG/AVIF to SDR WEBP to avoid HDR/gain-map rendering on capable displays
		if (ext === ".jpg" || ext === ".jpeg" || ext === ".avif") {
			const destName = `${basename(name, ext)}.webp`;
			const destPath = join(galleryDirPath, destName);
			if (!existsSync(destPath)) {
				try {
					mkdirSync(galleryDirPath, { recursive: true });
					// Force to sRGB to avoid HDR presentation; re-encode as 8-bit WEBP
					await sharp(fullPath)
						.toColorspace("srgb")
						.webp({ quality: 82 })
						.toFile(destPath);
				} catch {
					// Fallback to original if conversion fails
					if (!visited.has(name)) {
						items.push({
							url: `/gallery/${name}`,
							mtime: stats.mtimeMs,
						});
						visited.add(name);
					}
					continue;
				}
			}
			if (!visited.has(destName)) {
				const mtime = statSync(destPath).mtimeMs;
				items.push({ url: `/gallery/${destName}`, mtime });
				visited.add(destName);
			}
			continue;
		}

		// Regular supported formats
		if (!visited.has(name)) {
			items.push({ url: `/gallery/${name}`, mtime: stats.mtimeMs });
			visited.add(name);
		}
	}

	// Randomize order (Fisher–Yates shuffle)
	for (let i = items.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[items[i], items[j]] = [items[j], items[i]];
	}
	galleryImages = items.map((i) => i.url);
} catch {
	galleryImages = [];
}

// Build-time responsive variants and color LQIP placeholders for faster perceived loading
type GalleryMeta = {
	width: number;
	height: number;
	placeholder: string; // base64 data URI
	src: string; // default src (smallest responsive)
	srcset: string; // responsive candidates
};

let galleryMeta: Record<string, GalleryMeta> = {};

try {
	const galleryDirUrl = new URL("../../public/gallery/", import.meta.url);
	const galleryDirPath = fileURLToPath(galleryDirUrl);
	const resizedDirPath = fileURLToPath(
		new URL("../../public/gallery/_resized/", import.meta.url),
	);
	mkdirSync(resizedDirPath, { recursive: true });

	const buildMetaFor = async (url: string): Promise<GalleryMeta | null> => {
		try {
			const fileName = url.replace("/gallery/", "");
			const absPath = join(galleryDirPath, fileName);
			const meta = await sharp(absPath).metadata();
			const origWidth = meta.width || 0;
			const origHeight = meta.height || 0;
			if (!origWidth || !origHeight) return null;

			const candidateWidths = [320, 640, 960].filter(
				(w) => w <= origWidth,
			);
			const widths = candidateWidths.length
				? candidateWidths
				: [Math.min(320, Math.max(1, origWidth))];
			const entries: Array<{ url: string; w: number }> = [];

			for (const w of widths) {
				const outName = `${basename(fileName, extname(fileName))}-w${w}.webp`;
				const outPath = join(resizedDirPath, outName);
				if (!existsSync(outPath)) {
					await sharp(absPath)
						.toColorspace("srgb")
						.resize({ width: w })
						.webp({ quality: 80 })
						.toFile(outPath);
				}
				entries.push({ url: `/gallery/_resized/${outName}`, w });
			}

			const src = entries[0].url;
			const srcset = entries.map((e) => `${e.url} ${e.w}w`).join(", ");

			const lqipBuffer = await sharp(absPath)
				.toColorspace("srgb")
				.resize({ width: 24 })
				.webp({ quality: 40 })
				.toBuffer();
			const placeholder = `data:image/webp;base64,${lqipBuffer.toString("base64")}`;

			return {
				width: origWidth,
				height: origHeight,
				placeholder,
				src,
				srcset,
			};
		} catch {
			return null;
		}
	};

	for (const url of galleryImages) {
		const m = await buildMetaFor(url);
		if (m) galleryMeta[url] = m;
	}
} catch {}
---

<Layout
	title="Acts College SF: Christian Fellowship for SFSU & USF Students"
	description="Acts College SF is a Christian fellowship for college students and young professionals in San Francisco. We serve SFSU, USF, and CCSF. Join us for worship, Bible study, and community!"
>
	<section class="hero">
		<video
			autoplay
			loop
			muted
			playsinline
			class="hero-video"
			poster="/header-banners/unsplash-image-OD9EOzfSOh0.webp"
			preload="none"
		>
			<source
				src="/header-banners/Klesis SF Website Banner.mp4"
				type="video/mp4"
			/>
		</video>
		<div class="hero-overlay"></div>
		<div class="container">
			<h1>Welcome</h1>
			<p class="hero-subtitle">We're glad you're here!</p>
			<Button href="/connect" variant="primary" size="lg">I'M NEW!</Button
			>
		</div>
	</section>

	<section class="about-section">
		<div class="container">
			<h2>What is Acts College SF?</h2>
			<p>
				Acts College SF is a Christian fellowship serving college
				students and young professionals in the San Francisco area. We
				gather weekly for worship, Bible study, and fellowship as we
				grow together in our faith.
			</p>
		</div>
	</section>

	<section class="instagram-section">
		<div class="container">
			<h2>Follow Us on Instagram!</h2>
			<p class="instagram-description">
				We’re one community with two college fellowships: Koinonia at
				SFSU and Klesis near USF and CCSF John Adams.
			</p>
			<div class="instagram-embeds">
				<div class="instagram-embed-item">
					<iframe
						class="instagram-iframe"
						src="https://www.instagram.com/sfsukoinonia/embed/"
						frameborder="0"
						scrolling="no"
						allowtransparency="true"></iframe>
				</div>
				<div class="instagram-embed-item">
					<iframe
						class="instagram-iframe"
						src="https://www.instagram.com/klesis.sanfrancisco/embed/"
						frameborder="0"
						scrolling="no"
						allowtransparency="true"></iframe>
				</div>
			</div>
		</div>
	</section>

	<section class="events-section">
		<div class="container">
			<h2>Upcoming Events</h2>
			<p>Stay up to date with all our community events and activities</p>
			<div class="calendar-embed">
				<iframe
					class="calendar-month-view"
					src="https://calendar.google.com/calendar/u/0/embed?height=600&wkst=1&bgcolor=%23ffffff&ctz=America/Los_Angeles&showPrint=0&showTabs=0&showCalendars=0&src=Y19hZjg5NDZhZWMxMzkxZTJmOTY0YzIxZWVmYTY2NDM3MjNhNGEyZTM5MDkyYzU0ZDdjZGFmMWY0Y2NjMTQ0Mjk4QGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb20&color=%233F51B5&wmode=opaque"
					title="Klesis Events Calendar"
					width="100%"
					height="600"
					frameborder="0"
					scrolling="no"
					loading="lazy"
				>
				</iframe>
				<iframe
					class="calendar-list-view"
					src="https://calendar.google.com/calendar/u/0/embed?height=600&wkst=1&bgcolor=%23ffffff&ctz=America/Los_Angeles&showPrint=0&showTabs=0&showCalendars=0&src=Y19hZjg5NDZhZWMxMzkxZTJmOTY0YzIxZWVmYTY2NDM3MjNhNGEyZTM5MDkyYzU0ZDdjZGFmMWY0Y2NjMTQ0Mjk4QGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb20&color=%233F51B5&wmode=opaque&mode=AGENDA"
					title="Klesis Events Calendar"
					width="100%"
					height="600"
					frameborder="0"
					scrolling="no"
					loading="lazy"
				>
				</iframe>
			</div>
		</div>
	</section>

	<!-- Gallery Section at the bottom of the homepage -->
	<section class="gallery-section" aria-label="Photo gallery">
		<div class="container">
			<h2>Gallery</h2>
			<div class="gallery-grid">
				{
					galleryImages.map((href, index) => {
						const meta = galleryMeta[href];
						const eager = index < 8; // prioritize first rows
						const bgStyle = meta
							? `background-image: url('${meta.placeholder}'); background-size: cover; background-position: center; background-repeat: no-repeat;`
							: undefined;
						const getAltText = (url: string) => {
							try {
								const fileName =
									url
										.split("/")
										.pop()
										?.split(".")
										.slice(0, -1)
										.join(".") ?? "";
								const cleanedName = decodeURIComponent(
									fileName,
								).replace(/[_-]/g, " ");
								if (/^(PXL|IMG|DSC)/i.test(cleanedName)) {
									return "A photo from the Acts College SF gallery";
								}
								const finalName =
									cleanedName.charAt(0).toUpperCase() +
									cleanedName.slice(1);
								return `Acts College SF - ${finalName}`;
							} catch {
								return "A photo from the Acts College SF gallery";
							}
						};
						return (
							<a
								class="gallery-item"
								href={href}
								target="_blank"
								rel="noopener noreferrer"
								style={bgStyle}
							>
								<img
									src={meta ? meta.src : href}
									srcset={meta && meta.srcset}
									sizes="(max-width: 768px) 50vw, 25vw"
									width={meta && meta.width}
									height={meta && meta.height}
									alt={getAltText(href)}
									loading={eager ? "eager" : "lazy"}
									decoding="async"
									fetchpriority={eager ? "high" : "auto"}
								/>
							</a>
						);
					})
				}
			</div>
		</div>
	</section>
</Layout>
<script>
	document.addEventListener("DOMContentLoaded", () => {
		const video = document.querySelector(".hero-video") as HTMLVideoElement;
		video.load();

		// Fade-in gallery images when they are loaded and remove LQIP background
		const imgs = document.querySelectorAll(
			".gallery-item img",
		) as NodeListOf<HTMLImageElement>;
		imgs.forEach((img) => {
			const parent = img.closest(".gallery-item") as HTMLElement | null;
			const reveal = () => {
				if (!parent) return;
				parent.classList.add("loaded");
				parent.style.backgroundImage = "none";
			};
			if (img.complete && img.naturalWidth > 0) {
				reveal();
			} else {
				img.addEventListener("load", reveal, { once: true });
			}
		});
	});
</script>

<style>
	.container {
		max-width: var(--container-max-width);
		margin: 0 auto;
		padding: 0 var(--spacing-sm);
	}

	/* Hero Section */
	.hero {
		position: relative;
		overflow: hidden;
		color: white;
		padding: var(--spacing-xl) 0;
		text-align: center;
		min-height: 85vh;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.hero-video {
		position: absolute;
		top: 50%;
		left: 50%;
		min-width: 100%;
		min-height: 100%;
		width: auto;
		height: auto;
		z-index: -2;
		transform: translateX(-50%) translateY(-50%);
		object-fit: cover;
	}

	.hero-overlay {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: linear-gradient(
			to bottom,
			rgba(15, 23, 42, 0.3),
			rgba(15, 23, 42, 0.7)
		);
		z-index: -1;
		backdrop-filter: blur(1px);
	}

	.hero h1 {
		font-size: clamp(3rem, 8vw, 5rem);
		font-weight: 800;
		margin-bottom: var(--spacing-sm);
		line-height: 1.1;
		text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
		letter-spacing: -0.02em;
		color: white;
	}

	.hero-subtitle {
		font-size: clamp(1.25rem, 4vw, 1.5rem);
		margin-bottom: var(--spacing-lg);
		opacity: 0.95;
		max-width: 600px;
		margin-left: auto;
		margin-right: auto;
		font-weight: 500;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
	}

	/* Instagram Section */
	.instagram-section {
		padding: var(--spacing-xl) 0;
		background: var(--color-bg-alt);
		text-align: center;
	}

	.instagram-section h2 {
		font-size: 2.5rem;
		margin-bottom: var(--spacing-sm);
		color: var(--color-text);
	}

	.instagram-description {
		font-size: 1.125rem;
		line-height: 1.8;
		max-width: 800px;
		margin: 0 auto var(--spacing-lg);
		color: var(--color-text-light);
	}

	.instagram-embeds {
		display: flex;
		flex-wrap: wrap;
		justify-content: center;
		gap: var(--spacing-md);
	}

	.instagram-embed-item {
		flex: 1;
		min-width: 300px;
		max-width: 450px;
		background: var(--color-bg);
		border-radius: var(--radius-md);
		box-shadow: var(--shadow-lg);
		overflow: hidden;
		transition: var(--transition);
	}

	.instagram-embed-item:hover {
		transform: translateY(-4px);
		box-shadow: var(--shadow-xl);
	}

	.instagram-iframe {
		width: 100%;
		height: 500px;
		border: none;
	}

	/* About Section */
	.about-section {
		padding: var(--spacing-xl) 0;
		background: var(--color-bg);
	}

	.about-section h2 {
		font-size: 2.5rem;
		color: var(--color-text);
		margin-bottom: var(--spacing-md);
		text-align: center;
	}

	.about-section p {
		font-size: 1.25rem;
		line-height: 1.8;
		max-width: 800px;
		margin: 0 auto;
		text-align: center;
		color: var(--color-text-light);
	}

	/* Events Section */
	.events-section {
		padding: var(--spacing-xl) 0;
		background: var(--color-bg-alt);
		text-align: center;
	}

	.events-section h2 {
		font-size: 2.5rem;
		color: var(--color-text);
		margin-bottom: var(--spacing-xs);
	}

	.events-section p {
		font-size: 1.125rem;
		color: var(--color-text-light);
		margin-bottom: var(--spacing-lg);
	}

	.calendar-embed {
		max-width: 1000px;
		margin: 0 auto;
		border-radius: var(--radius-md);
		overflow: hidden;
		box-shadow: var(--shadow-lg);
		background: white;
		padding: var(--spacing-sm);
	}

	.calendar-embed iframe {
		width: 100%;
		height: 600px;
		border: none;
		display: block;
		border-radius: var(--radius-sm);
	}

	.calendar-embed .calendar-list-view {
		display: none;
	}

	/* Gallery Section */
	.gallery-section {
		padding: var(--spacing-xl) 0;
		background: var(--color-bg);
	}

	.gallery-section h2 {
		font-size: 2.5rem;
		color: var(--color-text);
		margin-bottom: var(--spacing-lg);
		text-align: center;
	}

	.gallery-grid {
		columns: 4 250px;
		column-gap: var(--spacing-sm);
	}

	.gallery-item {
		display: block;
		position: relative;
		border-radius: var(--radius-md);
		overflow: hidden;
		box-shadow: var(--shadow-md);
		background: var(--color-bg-alt);
		margin-bottom: var(--spacing-sm);
		break-inside: avoid;
		transition: var(--transition);
	}

	.gallery-item:hover {
		transform: scale(1.02);
		box-shadow: var(--shadow-xl);
		z-index: 10;
	}

	.gallery-item img {
		display: block;
		width: 100%;
		height: auto;
		object-fit: cover;
		transition: opacity 0.3s ease;
		opacity: 0;
	}

	.gallery-item.loaded img {
		opacity: 1;
	}

	/* Mobile Styles */
	@media (max-width: 768px) {
		.hero h1 {
			font-size: 3rem;
		}

		.calendar-embed .calendar-month-view {
			display: none;
		}

		.calendar-embed .calendar-list-view {
			display: block;
		}

		.calendar-embed iframe {
			height: 500px;
		}

		.gallery-grid {
			columns: 2 150px;
		}
	}
</style>
